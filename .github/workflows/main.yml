name: Wails Build & Release (Bun)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: false
        type: string

# Adicione permiss√µes ao GITHUB_TOKEN
permissions:
  contents: write
  packages: read

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  BUN_VERSION: "1.1.13"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build:
          - name: 'App-Linux'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
            artifact: 'app-linux-amd64'
          - name: 'App-Windows'
            platform: 'windows/amd64'
            os: 'windows-latest'
            artifact: 'app-windows-amd64.exe'
          - name: 'App-macOS'
            platform: 'darwin/arm64'
            os: 'macos-latest'
            artifact: 'app-darwin-arm64'

    runs-on: ${{ matrix.build.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clone SweetDesk-core
        shell: bash
        run: |
          cd ..
          # Usa PAT_TOKEN para clonar reposit√≥rio privado
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/pedro3pv/SweetDesk-core.git
          ls -la

      - name: Verify SweetDesk-core cloned
        shell: bash
        run: |
          if [ ! -d "../SweetDesk-core" ]; then
            echo "‚ùå SweetDesk-core not found"
            exit 1
          fi
          echo "‚úÖ SweetDesk-core found at ../SweetDesk-core"
          ls -la ../SweetDesk-core

      - name: Enable local SweetDesk-core replace directive
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            sed -i 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
          else
            sed -i.bak 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
            rm -f go.mod.bak
          fi
          cat go.mod | grep "replace"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Clean and Install dependencies with Bun
        working-directory: frontend
        shell: bash
        run: |
          # Remove node_modules e cache customizado se existir
          rm -rf node_modules
          rm -rf ../bun-install-cache
          
          # Limpar cache do Bun
          bun pm cache rm
          
          # Reinstalar sem cache customizado
          bun install --no-cache
          
          # Adicionar tipos faltantes
          bun add -d @types/gensync

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Install Linux dependencies
        if: matrix.build.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Criar symlink para webkit2gtk-4.0 apontar para 4.1
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc

      - name: Tidy Go modules
        run: go mod tidy

      - name: Generate code in SweetDesk-core
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ../SweetDesk-core
          go generate ./...

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Garble (for obfuscation)
        run: go install mvdan.cc/garble@latest

      - name: Build Wails with Bun (Obfuscated)
        run: wails build -obfuscated -platform ${{ matrix.build.platform }}

      - name: Verify and prepare macOS build
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "üîç Verificando build do macOS..."
          
          # Encontrar o .app
          APP_PATH=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Nenhum arquivo .app encontrado"
            exit 1
          fi
          
          echo "‚úÖ Encontrado: $APP_PATH"
          
          # Verificar estrutura do bundle
          if [ ! -d "$APP_PATH/Contents" ]; then
            echo "‚ùå Estrutura do .app inv√°lida (falta Contents/)"
            exit 1
          fi
          
          if [ ! -d "$APP_PATH/Contents/MacOS" ]; then
            echo "‚ùå Estrutura do .app inv√°lida (falta Contents/MacOS/)"
            exit 1
          fi
          
          if [ ! -f "$APP_PATH/Contents/Info.plist" ]; then
            echo "‚ùå Estrutura do .app inv√°lida (falta Contents/Info.plist)"
            exit 1
          fi
          
          echo "‚úÖ Estrutura do bundle v√°lida"
          
          # Listar estrutura
          echo "üìÇ Estrutura do bundle:"
          ls -lah "$APP_PATH/Contents/"
          
          # Remover atributos de quarentena
          echo "üîì Removendo atributos de quarentena..."
          xattr -cr "$APP_PATH"
          echo "‚úÖ Atributos removidos"
          
          # Verificar permiss√µes execut√°veis
          echo "üîê Verificando permiss√µes..."
          chmod +x "$APP_PATH/Contents/MacOS/"*
          echo "‚úÖ Permiss√µes configuradas"

      - name: Remove quarantine attribute (macOS only)
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "üîì Removendo atributo de quarentena do macOS..."
          find build/bin -name "*.app" -exec xattr -cr {} \;
          echo "‚úÖ Atributos de quarentena removidos"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.artifact }}
          path: |
            build/bin/*

  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display structure of downloaded files
        run: |
          echo "üì¶ Estrutura dos arquivos baixados:"
          ls -laR release-artifacts/

      - name: Prepare and package release files
        run: |
          mkdir -p release-files
          
          # Linux: Criar ZIP com bin√°rio
          if [ -d "release-artifacts/app-linux-amd64" ]; then
            echo "üì¶ Criando ZIP para Linux..."
            cd release-artifacts/app-linux-amd64
            zip -r ../../release-files/SweetDesk-linux-amd64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-linux-amd64.zip criado"
            
            # Verificar integridade
            echo "üîç Verificando ZIP Linux..."
            unzip -l release-files/SweetDesk-linux-amd64.zip | head -n 10
          fi
          
          # Windows: Criar ZIP com .exe
          if [ -d "release-artifacts/app-windows-amd64.exe" ]; then
            echo "üì¶ Criando ZIP para Windows..."
            cd release-artifacts/app-windows-amd64.exe
            zip -r ../../release-files/SweetDesk-windows-amd64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-windows-amd64.zip criado"
            
            # Verificar integridade
            echo "üîç Verificando ZIP Windows..."
            unzip -l release-files/SweetDesk-windows-amd64.zip | head -n 10
          fi
          
          # macOS: Criar TAR.GZ preservando symlinks e permiss√µes
          if [ -d "release-artifacts/app-darwin-arm64" ]; then
            echo "üì¶ Criando TAR.GZ para macOS..."
            
            # Encontrar o arquivo .app
            APP_PATH=$(find release-artifacts/app-darwin-arm64 -name "*.app" -type d -maxdepth 1 | head -n 1)
            
            if [ -z "$APP_PATH" ]; then
              echo "‚ùå Nenhum arquivo .app encontrado"
              ls -la release-artifacts/app-darwin-arm64/
              exit 1
            fi
            
            APP_NAME=$(basename "$APP_PATH")
            echo "‚úÖ Encontrado: $APP_NAME"
            
            # Verificar estrutura do bundle antes de empacotar
            if [ ! -d "$APP_PATH/Contents" ]; then
              echo "‚ùå Estrutura do .app inv√°lida (falta Contents/)"
              exit 1
            fi
            
            if [ ! -d "$APP_PATH/Contents/MacOS" ]; then
              echo "‚ùå Estrutura do .app inv√°lida (falta Contents/MacOS/)"
              exit 1
            fi
            
            echo "‚úÖ Estrutura do bundle v√°lida"
            
            # Criar TAR.GZ preservando symlinks, permiss√µes e metadata
            cd release-artifacts/app-darwin-arm64
            tar -czf ../../release-files/SweetDesk-darwin-arm64.tar.gz "$APP_NAME"
            cd ../..
            
            echo "‚úÖ SweetDesk-darwin-arm64.tar.gz criado"
            
            # Verificar integridade do TAR.GZ
            echo "üîç Verificando TAR.GZ macOS..."
            tar -tzf release-files/SweetDesk-darwin-arm64.tar.gz | grep -E "(Contents/MacOS|Contents/Info.plist)" | head -n 5
            
            if tar -tzf release-files/SweetDesk-darwin-arm64.tar.gz | grep -q "Contents/MacOS"; then
              echo "‚úÖ Estrutura do bundle preservada no arquivo"
            else
              echo "‚ö†Ô∏è AVISO: Estrutura do bundle pode estar incorreta"
            fi
            
            # Verificar se symlinks foram preservados
            if tar -tzf release-files/SweetDesk-darwin-arm64.tar.gz | grep -q "Frameworks"; then
              echo "‚úÖ Frameworks encontrados no arquivo"
            fi
          fi
          
          echo ""
          echo "üìã Arquivos preparados para release:"
          ls -lah release-files/
          echo ""
          echo "üìä Tamanho dos arquivos:"
          du -h release-files/*

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Release ${{ github.event.inputs.tag || github.ref_name }}
          body: |
            ## üéâ SweetDesk ${{ github.event.inputs.tag || github.ref_name }}
            
            ### üì¶ Downloads
            
            | Platform | File | Instala√ß√£o |
            |----------|------|------------|
            | üêß Linux (x64) | `SweetDesk-linux-amd64.zip` | Extrair e executar |
            | ü™ü Windows (x64) | `SweetDesk-windows-amd64.zip` | Extrair e executar .exe |
            | üçé macOS (ARM64) | `SweetDesk-darwin-arm64.tar.gz` | Extrair e mover para Aplicativos |
            
            ### ‚ö†Ô∏è Nota para usu√°rios macOS
            
            **Ap√≥s extrair o arquivo `.tar.gz`:**
            
            1. **Extrair o arquivo:**
               ```bash
               tar -xzf SweetDesk-darwin-arm64.tar.gz
               ```
            
            2. **Mover para a pasta Aplicativos:**
               ```bash
               mv SweetDesk.app /Applications/
               ```
            
            3. **Remover atributo de quarentena:**
               ```bash
               xattr -cr /Applications/SweetDesk.app
               ```
            
            4. **Executar pela primeira vez:**
               - Clique com bot√£o direito no app ‚Üí **Abrir** ‚Üí **Abrir**
               - Ou use o Launchpad normalmente ap√≥s a primeira abertura
            
            **Se ainda aparecer "danificado":**
            ```bash
            sudo spctl --master-disable
            sudo spctl --add --label "SweetDesk" /Applications/SweetDesk.app
            sudo spctl --master-enable
            ```
            
            ### üêõ Problemas conhecidos
            
            - **macOS Gatekeeper**: Apps n√£o assinados podem exibir avisos de seguran√ßa na primeira execu√ß√£o
            - **Solu√ß√£o permanente**: Use os comandos acima para adicionar exce√ß√£o
            
            ### üìù Changelog
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
