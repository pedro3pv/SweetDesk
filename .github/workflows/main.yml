name: Wails Build & Release (Bun)


on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: false
        type: string


# Adicione permiss√µes ao GITHUB_TOKEN
permissions:
  contents: write
  packages: read


env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  BUN_VERSION: "1.1.13"


jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build:
          - name: 'App-Linux'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
            artifact: 'app-linux-amd64'
          - name: 'App-Windows'
            platform: 'windows/amd64'
            os: 'windows-latest'
            artifact: 'app-windows-amd64.exe'
          - name: 'App-macOS'
            platform: 'darwin/arm64'
            os: 'macos-latest'
            artifact: 'app-darwin-arm64'


    runs-on: ${{ matrix.build.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive


      - name: Clone SweetDesk-core
        shell: bash
        run: |
          cd ..
          # Usa PAT_TOKEN para clonar reposit√≥rio privado
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/pedro3pv/SweetDesk-core.git
          ls -la


      - name: Verify SweetDesk-core cloned
        shell: bash
        run: |
          if [ ! -d "../SweetDesk-core" ]; then
            echo "‚ùå SweetDesk-core not found"
            exit 1
          fi
          echo "‚úÖ SweetDesk-core found at ../SweetDesk-core"
          ls -la ../SweetDesk-core


      - name: Enable local SweetDesk-core replace directive
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            sed -i 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
          else
            sed -i.bak 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
            rm -f go.mod.bak
          fi
          cat go.mod | grep "replace"


      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}


      - name: Clean and Install dependencies with Bun
        working-directory: frontend
        shell: bash
        run: |
          # Remove node_modules e cache customizado se existir
          rm -rf node_modules
          rm -rf ../bun-install-cache
          
          # Limpar cache do Bun
          bun pm cache rm
          
          # Reinstalar sem cache customizado
          bun install --no-cache
          
          # Adicionar tipos faltantes
          bun add -d @types/gensync


      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true


      - name: Install Linux dependencies
        if: matrix.build.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Criar symlink para webkit2gtk-4.0 apontar para 4.1
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc


      - name: Tidy Go modules
        run: go mod tidy


      - name: Generate code in SweetDesk-core
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ../SweetDesk-core
          go generate ./...


      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest


      - name: Install Garble (for obfuscation)
        run: go install mvdan.cc/garble@latest


      - name: Build Wails with Bun (Obfuscated)
        run: wails build -obfuscated -platform ${{ matrix.build.platform }}


      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.artifact }}
          path: |
            build/bin/*


  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts


      - name: Display structure of downloaded files
        run: |
          echo "üì¶ Estrutura dos arquivos baixados:"
          ls -laR release-artifacts/


      - name: Prepare and ZIP release files
        run: |
          mkdir -p release-files
          
          # Linux: Criar ZIP com bin√°rio
          if [ -d "release-artifacts/app-linux-amd64" ]; then
            echo "üì¶ Criando ZIP para Linux..."
            cd release-artifacts/app-linux-amd64
            zip -r ../../release-files/SweetDesk-linux-amd64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-linux-amd64.zip criado"
          fi
          
          # Windows: Criar ZIP com .exe
          if [ -d "release-artifacts/app-windows-amd64.exe" ]; then
            echo "üì¶ Criando ZIP para Windows..."
            cd release-artifacts/app-windows-amd64.exe
            zip -r ../../release-files/SweetDesk-windows-amd64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-windows-amd64.zip criado"
          fi
          
          # macOS: Criar ZIP com .app
          if [ -d "release-artifacts/app-darwin-arm64" ]; then
            echo "üì¶ Criando ZIP para macOS..."
            cd release-artifacts/app-darwin-arm64
            zip -r ../../release-files/SweetDesk-darwin-arm64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-darwin-arm64.zip criado"
          fi
          
          echo ""
          echo "üìã Arquivos preparados para release:"
          ls -lah release-files/
          echo ""
          echo "üìä Tamanho dos ZIPs:"
          du -h release-files/*.zip


      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Release ${{ github.event.inputs.tag || github.ref_name }}
          body: |
            ## üéâ SweetDesk ${{ github.event.inputs.tag || github.ref_name }}
            
            ### üì¶ Downloads
            
            | Platform | File |
            |----------|------|
            | üêß Linux (x64) | `SweetDesk-linux-amd64.zip` |
            | ü™ü Windows (x64) | `SweetDesk-windows-amd64.zip` |
            | üçé macOS (ARM64) | `SweetDesk-darwin-arm64.zip` |
            
            ### üìù Changelog
          files: release-files/*.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
