name: Wails Build & Release (Bun)


on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: false
        type: string


# Adicione permissÃµes ao GITHUB_TOKEN
permissions:
  contents: write
  packages: read


env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  BUN_VERSION: "1.1.13"


jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build:
          - name: 'App-Linux'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
            artifact: 'app-linux-amd64'
          - name: 'App-Windows'
            platform: 'windows/amd64'
            os: 'windows-latest'
            artifact: 'app-windows-amd64.exe'
          - name: 'App-macOS'
            platform: 'darwin/arm64'
            os: 'macos-latest'
            artifact: 'app-darwin-arm64'


    runs-on: ${{ matrix.build.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive


      - name: Clone SweetDesk-core
        shell: bash
        run: |
          cd ..
          # Usa PAT_TOKEN para clonar repositÃ³rio privado
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/pedro3pv/SweetDesk-core.git
          ls -la


      - name: Verify SweetDesk-core cloned
        shell: bash
        run: |
          if [ ! -d "../SweetDesk-core" ]; then
            echo "âŒ SweetDesk-core not found"
            exit 1
          fi
          echo "âœ… SweetDesk-core found at ../SweetDesk-core"
          ls -la ../SweetDesk-core


      - name: Enable local SweetDesk-core replace directive
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            sed -i 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
          else
            sed -i.bak 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
            rm -f go.mod.bak
          fi
          cat go.mod | grep "replace"


      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}


      - name: Clean and Install dependencies with Bun
        working-directory: frontend
        shell: bash
        run: |
          # Remove node_modules e cache customizado se existir
          rm -rf node_modules
          rm -rf ../bun-install-cache

          # Limpar cache do Bun
          bun pm cache rm

          # Reinstalar sem cache customizado
          bun install --no-cache

          # Adicionar tipos faltantes
          bun add -d @types/gensync


      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true


      - name: Install Linux dependencies
        if: matrix.build.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Criar symlink para webkit2gtk-4.0 apontar para 4.1
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc


      - name: Tidy Go modules
        run: go mod tidy


      # DESATIVADO: Generate code in SweetDesk-core
      # - name: Generate code in SweetDesk-core
      #   shell: bash
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     cd ../SweetDesk-core
      #     go generate ./...


      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest


      # REMOVIDO para macOS: InstalaÃ§Ã£o do Garble (nÃ£o necessÃ¡rio para build debug)
      # - name: Install Garble (for obfuscation)
      #   if: matrix.build.os != 'macos-latest'
      #   run: go install mvdan.cc/garble@latest


      - name: Build Wails with Bun
        if: matrix.build.os != 'macos-latest'
        run: wails build -platform ${{ matrix.build.platform }}


      # Build debug como build principal para macOS
      - name: Build Wails (Debug mode - macOS)
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "ğŸ”§ Construindo versÃ£o debug para macOS..."
          wails build -debug -platform ${{ matrix.build.platform }}
          echo "âœ… Build debug concluÃ­do"


      - name: Verify and prepare macOS build
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "ğŸ” Verificando build do macOS..."

          # Encontrar o .app
          APP_PATH=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ Nenhum arquivo .app encontrado"
            exit 1
          fi

          echo "âœ… Encontrado: $APP_PATH"

          # Verificar estrutura do bundle
          if [ ! -d "$APP_PATH/Contents" ]; then
            echo "âŒ Estrutura do .app invÃ¡lida (falta Contents/)"
            exit 1
          fi

          if [ ! -d "$APP_PATH/Contents/MacOS" ]; then
            echo "âŒ Estrutura do .app invÃ¡lida (falta Contents/MacOS/)"
            exit 1
          fi

          if [ ! -f "$APP_PATH/Contents/Info.plist" ]; then
            echo "âŒ Estrutura do .app invÃ¡lida (falta Contents/Info.plist)"
            exit 1
          fi

          echo "âœ… Estrutura do bundle vÃ¡lida"

          # Listar estrutura
          echo "ğŸ“‚ Estrutura do bundle:"
          ls -lah "$APP_PATH/Contents/"

          # Remover atributos de quarentena
          echo "ğŸ”“ Removendo atributos de quarentena..."
          xattr -cr "$APP_PATH"
          echo "âœ… Atributos removidos"

          # Verificar permissÃµes executÃ¡veis
          echo "ğŸ” Verificando permissÃµes..."
          chmod +x "$APP_PATH/Contents/MacOS/"*
          echo "âœ… PermissÃµes configuradas"


      - name: Ad-hoc sign macOS app
        if: matrix.build.os == 'macos-latest'
        run: |
          APP_PATH=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)

          echo "ğŸ” Signing $(basename "$APP_PATH")..."

          # Sign internal frameworks/dylibs first if they exist
          # --options runtime Ã© necessÃ¡rio para NSOpenPanel funcionar (file dialogs)
          if [ -d "$APP_PATH/Contents/Frameworks" ]; then
            echo "  ğŸ“š Signing frameworks and libraries..."
            find "$APP_PATH/Contents/Frameworks" -name "*.dylib" -exec codesign --force --options runtime -s - {} \;
            find "$APP_PATH/Contents/Frameworks" -name "*.framework" -exec codesign --force --options runtime -s - {} \;
          fi

          # Sign the app bundle with entitlements and hardened runtime
          # --deep garante signing recursivo completo
          # --options runtime ativa hardened runtime (necessÃ¡rio para permissÃµes de file system)
          echo "  ğŸ” Signing app bundle with entitlements..."
          codesign --force --deep --options runtime --entitlements build/darwin/entitlements.plist -s - "$APP_PATH"

          # Verify signature
          echo "  ğŸ” Verifying signature..."
          codesign -vv "$APP_PATH"

          # Verify entitlements were applied
          echo "  ğŸ” Verifying entitlements..."
          codesign -d --entitlements - "$APP_PATH" | grep -q "com.apple.security.files.user-selected" && echo "  âœ… File access entitlement present"

          # Verify hardened runtime
          echo "  ğŸ” Verifying hardened runtime..."
          codesign -d --verbose=4 "$APP_PATH" 2>&1 | grep -q "runtime" && echo "  âœ… Hardened runtime enabled"

          echo "âœ… App signing complete"


      - name: Create DMG (macOS only)
        if: matrix.build.os == 'macos-latest'
        run: |
          # Install create-dmg
          brew install create-dmg

          APP_PATH=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)
          APP_NAME=$(basename "$APP_PATH" .app)

          echo "ğŸ“¦ Creating DMG for $APP_NAME..."

          create-dmg \
            --volname "$APP_NAME" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME.app" 150 190 \
            --app-drop-link 450 190 \
            --no-internet-enable \
            "build/bin/${APP_NAME}-darwin-arm64.dmg" \
            "$APP_PATH" || echo "âš ï¸  Warning: DMG creation had issues, but continuing..."

          if [ -f "build/bin/${APP_NAME}-darwin-arm64.dmg" ]; then
            echo "âœ… DMG created: build/bin/${APP_NAME}-darwin-arm64.dmg"
            ls -lah build/bin/*.dmg
          fi


      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.artifact }}
          path: |
            ${{ matrix.build.os == 'macos-latest' && 'build/bin/*.dmg' || 'build/bin/*' }}


  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts


      - name: Display structure of downloaded files
        run: |
          echo "ğŸ“¦ Estrutura dos arquivos baixados:"
          ls -laR release-artifacts/


      - name: Prepare and package release files
        run: |
          mkdir -p release-files

          # Linux: Criar ZIP com binÃ¡rio
          if [ -d "release-artifacts/app-linux-amd64" ]; then
            echo "ğŸ“¦ Criando ZIP para Linux..."
            cd release-artifacts/app-linux-amd64
            zip -r ../../release-files/SweetDesk-linux-amd64.zip ./*
            cd ../..
            echo "âœ… SweetDesk-linux-amd64.zip criado"

            # Verificar integridade
            echo "ğŸ” Verificando ZIP Linux..."
            unzip -l release-files/SweetDesk-linux-amd64.zip | head -n 10
          fi

          # Windows: Criar ZIP com .exe
          if [ -d "release-artifacts/app-windows-amd64.exe" ]; then
            echo "ğŸ“¦ Criando ZIP para Windows..."
            cd release-artifacts/app-windows-amd64.exe
            zip -r ../../release-files/SweetDesk-windows-amd64.zip ./*
            cd ../..
            echo "âœ… SweetDesk-windows-amd64.zip criado"

            # Verificar integridade
            echo "ğŸ” Verificando ZIP Windows..."
            unzip -l release-files/SweetDesk-windows-amd64.zip | head -n 10
          fi

          # macOS: O DMG jÃ¡ estÃ¡ pronto
          if [ -d "release-artifacts/app-darwin-arm64" ]; then
            echo "ğŸ“¦ Preparando DMG para macOS..."

            # Encontrar o arquivo .dmg
            DMG_PATH=$(find release-artifacts/app-darwin-arm64 -name "*.dmg" -maxdepth 1 | head -n 1)

            if [ -z "$DMG_PATH" ]; then
              echo "âŒ Nenhum arquivo .dmg encontrado"
              ls -la release-artifacts/app-darwin-arm64/
              exit 1
            fi

            cp "$DMG_PATH" release-files/SweetDesk-darwin-arm64.dmg
            echo "âœ… SweetDesk-darwin-arm64.dmg copiado"
          fi

          echo ""
          echo "ğŸ“‹ Arquivos preparados para release:"
          ls -lah release-files/
          echo ""
          echo "ğŸ“Š Tamanho dos arquivos:"
          du -h release-files/*


      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Release ${{ github.event.inputs.tag || github.ref_name }}
          body: |
            ## ğŸ‰ SweetDesk ${{ github.event.inputs.tag || github.ref_name }}

            ### ğŸ“¦ Downloads

            | Platform | File | InstalaÃ§Ã£o |
            |----------|------|------------|
            | ğŸ§ Linux (x64) | `SweetDesk-linux-amd64.zip` | Extrair e executar |
            | ğŸªŸ Windows (x64) | `SweetDesk-windows-amd64.zip` | Extrair e executar .exe |
            | ğŸ macOS (ARM64) | `SweetDesk-darwin-arm64.dmg` | Abrir DMG e arrastar para Aplicativos |

            ### âš ï¸ Nota para usuÃ¡rios macOS

            **O app Ã© assinado com ad-hoc signing.** Na primeira execuÃ§Ã£o:

            1. **Abrir o DMG** e arrastar o SweetDesk para a pasta Aplicativos
            2. **Primeira execuÃ§Ã£o:** Clique com botÃ£o direito no app â†’ **Abrir** â†’ **Abrir**
            3. Ou vÃ¡ em **ConfiguraÃ§Ãµes do Sistema â†’ Privacidade e SeguranÃ§a** e permita o app

            O app pedirÃ¡ permissÃ£o para acessar pastas (Imagens, Downloads, etc.) na primeira vez que salvar arquivos.

            ### ğŸ”§ VersÃ£o de Desenvolvimento

            **macOS:** Esta versÃ£o Ã© compilada em modo debug para facilitar troubleshooting durante a fase alpha.

            ### ğŸ› Problemas conhecidos

            - **macOS Gatekeeper**: Apps nÃ£o assinados oficialmente podem exibir avisos de seguranÃ§a na primeira execuÃ§Ã£o

            ### ğŸ“ Changelog
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
