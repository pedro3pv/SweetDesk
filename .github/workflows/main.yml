name: Wails Build & Release (Bun)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: false
        type: string

# Adicione permiss√µes ao GITHUB_TOKEN
permissions:
  contents: write
  packages: read

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  BUN_VERSION: "1.1.13"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build:
          - name: 'App-Linux'
            platform: 'linux/amd64'
            os: 'ubuntu-latest'
            artifact: 'app-linux-amd64'
          - name: 'App-Windows'
            platform: 'windows/amd64'
            os: 'windows-latest'
            artifact: 'app-windows-amd64.exe'
          - name: 'App-macOS'
            platform: 'darwin/arm64'
            os: 'macos-latest'
            artifact: 'app-darwin-arm64'

    runs-on: ${{ matrix.build.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clone SweetDesk-core
        shell: bash
        run: |
          cd ..
          # Usa PAT_TOKEN para clonar reposit√≥rio privado
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/pedro3pv/SweetDesk-core.git
          ls -la

      - name: Verify SweetDesk-core cloned
        shell: bash
        run: |
          if [ ! -d "../SweetDesk-core" ]; then
            echo "‚ùå SweetDesk-core not found"
            exit 1
          fi
          echo "‚úÖ SweetDesk-core found at ../SweetDesk-core"
          ls -la ../SweetDesk-core

      - name: Enable local SweetDesk-core replace directive
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            sed -i 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
          else
            sed -i.bak 's|// replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|replace github.com/pedro3pv/SweetDesk-core => ../SweetDesk-core|g' go.mod
            rm -f go.mod.bak
          fi
          cat go.mod | grep "replace"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Clean and Install dependencies with Bun
        working-directory: frontend
        shell: bash
        run: |
          # Remove node_modules e cache customizado se existir
          rm -rf node_modules
          rm -rf ../bun-install-cache
          
          # Limpar cache do Bun
          bun pm cache rm
          
          # Reinstalar sem cache customizado
          bun install --no-cache
          
          # Adicionar tipos faltantes
          bun add -d @types/gensync

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Install Linux dependencies
        if: matrix.build.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Criar symlink para webkit2gtk-4.0 apontar para 4.1
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc

      - name: Tidy Go modules
        run: go mod tidy

      - name: Generate code in SweetDesk-core
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ../SweetDesk-core
          go generate ./...

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Garble (for obfuscation)
        run: go install mvdan.cc/garble@latest

      - name: Build Wails with Bun (Obfuscated)
        run: wails build -obfuscated -platform ${{ matrix.build.platform }}

      - name: Rename production build (macOS)
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "üìù Renomeando build de produ√ß√£o..."
          APP_PATH=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            APP_NAME=$(basename "$APP_PATH" .app)
            mv "$APP_PATH" "build/bin/${APP_NAME}-production.app"
            echo "‚úÖ Renomeado para ${APP_NAME}-production.app"
          fi

      - name: Build Wails (Debug mode)
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "üîß Construindo vers√£o debug..."
          wails build -debug -platform ${{ matrix.build.platform }}
          echo "‚úÖ Build debug conclu√≠do"

      - name: Organize debug and production builds (macOS)
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "üì¶ Organizando builds..."
          
          # Encontrar o debug build (rec√©m criado)
          DEBUG_APP=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)
          if [ -n "$DEBUG_APP" ]; then
            APP_NAME=$(basename "$DEBUG_APP" .app)
            mv "$DEBUG_APP" "build/bin/${APP_NAME}-debug.app"
            echo "‚úÖ Debug build: ${APP_NAME}-debug.app"
          fi
          
          # Restaurar nome original do production build
          PROD_APP=$(find build/bin -name "*-production.app" -type d -maxdepth 1 | head -n 1)
          if [ -n "$PROD_APP" ]; then
            APP_NAME=$(basename "$PROD_APP" -production.app)
            mv "$PROD_APP" "build/bin/${APP_NAME}.app"
            echo "‚úÖ Production build: ${APP_NAME}.app"
          fi
          
          echo "üìÇ Builds dispon√≠veis:"
          ls -lh build/bin/

      - name: Verify and prepare macOS build
        if: matrix.build.os == 'macos-latest'
        run: |
          echo "üîç Verificando build do macOS..."
          
          # Encontrar o .app
          APP_PATH=$(find build/bin -name "*.app" -type d -maxdepth 1 | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Nenhum arquivo .app encontrado"
            exit 1
          fi
          
          echo "‚úÖ Encontrado: $APP_PATH"
          
          # Verificar estrutura do bundle
          if [ ! -d "$APP_PATH/Contents" ]; then
            echo "‚ùå Estrutura do .app inv√°lida (falta Contents/)"
            exit 1
          fi
          
          if [ ! -d "$APP_PATH/Contents/MacOS" ]; then
            echo "‚ùå Estrutura do .app inv√°lida (falta Contents/MacOS/)"
            exit 1
          fi
          
          if [ ! -f "$APP_PATH/Contents/Info.plist" ]; then
            echo "‚ùå Estrutura do .app inv√°lida (falta Contents/Info.plist)"
            exit 1
          fi
          
          echo "‚úÖ Estrutura do bundle v√°lida"
          
          # Listar estrutura
          echo "üìÇ Estrutura do bundle:"
          ls -lah "$APP_PATH/Contents/"
          
          # Remover atributos de quarentena
          echo "üîì Removendo atributos de quarentena..."
          xattr -cr "$APP_PATH"
          echo "‚úÖ Atributos removidos"
          
          # Verificar permiss√µes execut√°veis
          echo "üîê Verificando permiss√µes..."
          chmod +x "$APP_PATH/Contents/MacOS/"*
          echo "‚úÖ Permiss√µes configuradas"

      - name: Ad-hoc sign macOS apps (Production & Debug)
        if: matrix.build.os == 'macos-latest'
        run: |
          # Fun√ß√£o para assinar um app com hardened runtime
          sign_app() {
            local APP_PATH="$1"
            local APP_TYPE="$2"
            
            echo "üîè Signing $APP_TYPE: $(basename "$APP_PATH")..."
            
            # Sign internal frameworks/dylibs first if they exist
            # --options runtime √© necess√°rio para NSOpenPanel funcionar (file dialogs)
            if [ -d "$APP_PATH/Contents/Frameworks" ]; then
              echo "  üìö Signing frameworks and libraries..."
              find "$APP_PATH/Contents/Frameworks" -name "*.dylib" -exec codesign --force --options runtime -s - {} \;
              find "$APP_PATH/Contents/Frameworks" -name "*.framework" -exec codesign --force --options runtime -s - {} \;
            fi
            
            # Sign the app bundle with entitlements and hardened runtime
            # --deep garante signing recursivo completo
            # --options runtime ativa hardened runtime (necess√°rio para permiss√µes de file system)
            echo "  üîè Signing app bundle with entitlements..."
            codesign --force --deep --options runtime --entitlements build/darwin/entitlements.plist -s - "$APP_PATH"
            
            # Verify signature
            echo "  üîç Verifying signature..."
            codesign -vv "$APP_PATH"
            
            # Verify entitlements were applied
            echo "  üîç Verifying entitlements..."
            codesign -d --entitlements - "$APP_PATH" | grep -q "com.apple.security.files.user-selected" && echo "  ‚úÖ File access entitlement present"
            
            # Verify hardened runtime
            echo "  üîç Verifying hardened runtime..."
            codesign -d --verbose=4 "$APP_PATH" 2>&1 | grep -q "runtime" && echo "  ‚úÖ Hardened runtime enabled"
            
            echo "‚úÖ $APP_TYPE signing complete"
          }
          
          # Assinar production build
          PROD_APP=$(find build/bin -name "*.app" -type d -maxdepth 1 ! -name "*-debug.app" | head -n 1)
          if [ -n "$PROD_APP" ]; then
            sign_app "$PROD_APP" "Production"
          fi
          
          # Assinar debug build
          DEBUG_APP=$(find build/bin -name "*-debug.app" -type d -maxdepth 1 | head -n 1)
          if [ -n "$DEBUG_APP" ]; then
            sign_app "$DEBUG_APP" "Debug"
          fi
          
          echo "‚úÖ All apps signed successfully"

      - name: Create DMG (macOS only)
        if: matrix.build.os == 'macos-latest'
        run: |
          # Install create-dmg
          brew install create-dmg
          
          # Fun√ß√£o para criar DMG
          create_dmg_for_app() {
            local APP_PATH="$1"
            local DMG_SUFFIX="$2"
            local APP_NAME=$(basename "$APP_PATH" .app)
            local BASE_NAME=$(echo "$APP_NAME" | sed 's/-debug$//')
            
            echo "üì¶ Creating DMG for $APP_NAME..."
            
            create-dmg \
              --volname "$BASE_NAME" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "$APP_NAME.app" 150 190 \
              --app-drop-link 450 190 \
              --no-internet-enable \
              "build/bin/${BASE_NAME}-darwin-arm64${DMG_SUFFIX}.dmg" \
              "$APP_PATH" || echo "‚ö†Ô∏è  Warning: DMG creation had issues, but continuing..."
            
            if [ -f "build/bin/${BASE_NAME}-darwin-arm64${DMG_SUFFIX}.dmg" ]; then
              echo "‚úÖ DMG created: build/bin/${BASE_NAME}-darwin-arm64${DMG_SUFFIX}.dmg"
            fi
          }
          
          # Criar DMG para production build
          PROD_APP=$(find build/bin -name "*.app" -type d -maxdepth 1 ! -name "*-debug.app" | head -n 1)
          if [ -n "$PROD_APP" ]; then
            create_dmg_for_app "$PROD_APP" ""
          fi
          
          # Criar DMG para debug build
          DEBUG_APP=$(find build/bin -name "*-debug.app" -type d -maxdepth 1 | head -n 1)
          if [ -n "$DEBUG_APP" ]; then
            create_dmg_for_app "$DEBUG_APP" "-debug"
          fi
          
          echo "üì¶ DMGs dispon√≠veis:"
          ls -lah build/bin/*.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build.artifact }}
          # Para macOS: inclui ambos DMGs (production e debug)
          # Debug build √∫til para troubleshooting durante fase alpha
          path: |
            ${{ matrix.build.os == 'macos-latest' && 'build/bin/*.dmg' || 'build/bin/*' }}

  create-release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display structure of downloaded files
        run: |
          echo "üì¶ Estrutura dos arquivos baixados:"
          ls -laR release-artifacts/

      - name: Prepare and package release files
        run: |
          mkdir -p release-files
          
          # Linux: Criar ZIP com bin√°rio
          if [ -d "release-artifacts/app-linux-amd64" ]; then
            echo "üì¶ Criando ZIP para Linux..."
            cd release-artifacts/app-linux-amd64
            zip -r ../../release-files/SweetDesk-linux-amd64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-linux-amd64.zip criado"
            
            # Verificar integridade
            echo "üîç Verificando ZIP Linux..."
            unzip -l release-files/SweetDesk-linux-amd64.zip | head -n 10
          fi
          
          # Windows: Criar ZIP com .exe
          if [ -d "release-artifacts/app-windows-amd64.exe" ]; then
            echo "üì¶ Criando ZIP para Windows..."
            cd release-artifacts/app-windows-amd64.exe
            zip -r ../../release-files/SweetDesk-windows-amd64.zip ./*
            cd ../..
            echo "‚úÖ SweetDesk-windows-amd64.zip criado"
            
            # Verificar integridade
            echo "üîç Verificando ZIP Windows..."
            unzip -l release-files/SweetDesk-windows-amd64.zip | head -n 10
          fi
          
          # macOS: O DMG j√° est√° pronto
          if [ -d "release-artifacts/app-darwin-arm64" ]; then
            echo "üì¶ Preparando DMG para macOS..."
            
            # Encontrar o arquivo .dmg
            DMG_PATH=$(find release-artifacts/app-darwin-arm64 -name "*.dmg" -maxdepth 1 | head -n 1)
            
            if [ -z "$DMG_PATH" ]; then
              echo "‚ùå Nenhum arquivo .dmg encontrado"
              ls -la release-artifacts/app-darwin-arm64/
              exit 1
            fi
            
            cp "$DMG_PATH" release-files/SweetDesk-darwin-arm64.dmg
            echo "‚úÖ SweetDesk-darwin-arm64.dmg copiado"
          fi
          
          echo ""
          echo "üìã Arquivos preparados para release:"
          ls -lah release-files/
          echo ""
          echo "üìä Tamanho dos arquivos:"
          du -h release-files/*

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Release ${{ github.event.inputs.tag || github.ref_name }}
          body: |
            ## üéâ SweetDesk ${{ github.event.inputs.tag || github.ref_name }}
            
            ### üì¶ Downloads
            
            | Platform | File | Instala√ß√£o |
            |----------|------|------------|
            | üêß Linux (x64) | `SweetDesk-linux-amd64.zip` | Extrair e executar |
            | ü™ü Windows (x64) | `SweetDesk-windows-amd64.zip` | Extrair e executar .exe |
            | üçé macOS (ARM64) | `SweetDesk-darwin-arm64.dmg` | Abrir DMG e arrastar para Aplicativos |
            
            ### ‚ö†Ô∏è Nota para usu√°rios macOS
            
            **O app √© assinado com ad-hoc signing.** Na primeira execu√ß√£o:
            
            1. **Abrir o DMG** e arrastar o SweetDesk para a pasta Aplicativos
            2. **Primeira execu√ß√£o:** Clique com bot√£o direito no app ‚Üí **Abrir** ‚Üí **Abrir**
            3. Ou v√° em **Configura√ß√µes do Sistema ‚Üí Privacidade e Seguran√ßa** e permita o app
            
            O app pedir√° permiss√£o para acessar pastas (Imagens, Downloads, etc.) na primeira vez que salvar arquivos.
            
            ### üêõ Problemas conhecidos
            
            - **macOS Gatekeeper**: Apps n√£o assinados oficialmente podem exibir avisos de seguran√ßa na primeira execu√ß√£o
            
            ### üìù Changelog
          files: release-files/*
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
